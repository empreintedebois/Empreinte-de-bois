name: Apply updated zip

on:
  push:
    paths:
      - "Empreinte-de-bois-updated.zip"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  apply:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------
      # Checkout du repo
      # ---------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # Dépendances
      # ---------------------------------------------------
      - name: Install unzip and rsync
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip rsync

      # ---------------------------------------------------
      # Extraction du ZIP
      # ---------------------------------------------------
      - name: Extract Empreinte-de-bois-updated.zip
        run: |
          rm -rf .__zip_extract__
          mkdir -p .__zip_extract__
          unzip -o "Empreinte-de-bois-updated.zip" -d .__zip_extract__

      # ---------------------------------------------------
      # Cas B : un seul dossier racine dans le zip
      # ---------------------------------------------------
      - name: Detect single root folder (case B)
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          ROOT=".__zip_extract__"

          mapfile -t DIRS < <(find "$ROOT" -mindepth 1 -maxdepth 1 -type d)

          if [ "${#DIRS[@]}" -ne 1 ]; then
            echo "ERROR: Expected exactly ONE top-level folder in the zip."
            ls -la "$ROOT"
            exit 1
          fi

          echo "src=${DIRS[0]}" >> "$GITHUB_OUTPUT"
          echo "Detected zip root: ${DIRS[0]}"

      # ---------------------------------------------------
      # Sécurité minimale : éviter zip foireux
      # ---------------------------------------------------
      - name: Safety checks
        shell: bash
        run: |
          set -euo pipefail
          SRC="${{ steps.detect.outputs.src }}"

          test -f "$SRC/index.html" || (echo "ERROR: index.html missing" && exit 1)
          test -d "$SRC/assets"     || (echo "ERROR: assets/ missing" && exit 1)

          echo "Safety checks OK"

      # ---------------------------------------------------
      # Application des fichiers (overwrite / add ONLY)
      # ---------------------------------------------------
      - name: Apply files from zip (safe mode)
        shell: bash
        run: |
          set -euo pipefail
          SRC="${{ steps.detect.outputs.src }}"

          # IMPORTANT :
          # - Pas de --delete  -> rien n'est supprimé
          # - Exclusion .github -> pas de workflows touchés
          # - Exclusion galerie auto -> pas d'écrasement
          rsync -a --checksum \
            --exclude ".git/" \
            --exclude ".github/" \
            --exclude "assets/galerie/" \
            --exclude "data/gallery.json" \
            --exclude "__MACOSX/" \
            --exclude ".DS_Store" \
            "$SRC"/ ./

      # ---------------------------------------------------
      # Nettoyage
      # ---------------------------------------------------
      - name: Cleanup temp files
        run: rm -rf .__zip_extract__

      # ---------------------------------------------------
      # Commit automatique si changements
      # ---------------------------------------------------
      - name: Commit and push changes
        shell: bash
        run: |
          set -euo pipefail

          if git status --porcelain | grep -q .; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Apply Empreinte-de-bois-updated.zip"
            git push
          else
            echo "No changes detected – nothing to commit."
          fi
