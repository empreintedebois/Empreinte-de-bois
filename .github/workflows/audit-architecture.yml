
name: Audit architecture V2 (mono-page)

on:
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Audit complet V2
        run: |
          python - << 'PY'
          import re, json
          from pathlib import Path

          ROOT = Path(".")
          INDEX = ROOT / "index.html"

          def norm(p): 
            return p.split("?")[0].replace("\\","/")

          def is_ignored(ref: str) -> bool:
            ref = ref.strip()
            return (
              ref.startswith("#") or
              ref.startswith("http://") or ref.startswith("https://") or
              ref.startswith("mailto:") or ref.startswith("tel:") or
              ref.startswith("data:") or
              ref == ""
            )

          referenced = set()

          # --- HTML refs (src/href/poster) ---
          html = INDEX.read_text(encoding="utf-8", errors="ignore")
          for attr in ["src", "href", "poster"]:
            for m in re.findall(rf'{attr}="([^"]+)"', html):
              if not is_ignored(m):
                referenced.add(norm(m))

          # --- CSS url(...) ---
          for css in ROOT.rglob("*.css"):
            txt = css.read_text(encoding="utf-8", errors="ignore")
            for m in re.findall(r'url\(["\']?([^"\')]+)["\']?\)', txt):
              if not is_ignored(m):
                referenced.add(norm(m))

          # --- JS: fetch() + strings assets/... + data/... ---
          for js in ROOT.rglob("*.js"):
            txt = js.read_text(encoding="utf-8", errors="ignore")

            for m in re.findall(r'fetch\(["\']([^"\']+)["\']', txt):
              if not is_ignored(m):
                referenced.add(norm(m))

            for m in re.findall(r'(["\'])(assets/[^"\']+)\1', txt):
              referenced.add(norm(m[1]))

            for m in re.findall(r'(["\'])(data/[^"\']+)\1', txt):
              referenced.add(norm(m[1]))

            for m in re.findall(r'(["\'])(config/[^"\']+)\1', txt):
              referenced.add(norm(m[1]))

          # --- JSON configs: scan for string paths ---
          for j in list(ROOT.rglob("*.json")):
            try:
              obj = json.loads(j.read_text(encoding="utf-8"))
            except Exception:
              continue
            blob = json.dumps(obj, ensure_ascii=False)
            for m in re.findall(r'(assets/[^"\\\s]+)', blob):
              referenced.add(norm(m))
            for m in re.findall(r'(data/[^"\\\s]+)', blob):
              referenced.add(norm(m))
            for m in re.findall(r'(config/[^"\\\s]+)', blob):
              referenced.add(norm(m))

          # Galerie JSON => ajoute thumb/full si présents
          gj = ROOT / "data/gallery.json"
          if gj.exists():
            try:
              data = json.loads(gj.read_text(encoding="utf-8"))
              for it in data.get("items", []):
                for k in ("thumb","full","src"):
                  if k in it and it[k]:
                    referenced.add(norm(it[k]))
            except Exception:
              pass

          # Tous les fichiers du repo (hors .git)
          all_files = set(
            str(p).replace("\\","/")
            for p in ROOT.rglob("*")
            if p.is_file() and ".git" not in p.parts
          )

          unused = sorted(f for f in all_files if f not in referenced)
          missing = sorted(f for f in referenced if not Path(f).exists())

          print("\n=== AUDIT V2 ===\n")
          print("\n--- UTILISÉS (référencés) ---")
          for f in sorted(referenced):
            print("✓", f)

          print("\n--- ORPHELINS (présents mais non référencés) ---")
          for f in unused:
            print("⚠️", f)

          print("\n--- MANQUANTS (référencés mais absents) ---")
          for f in missing:
            print("❌", f)

          print("\n=== FIN AUDIT V2 ===\n")
          PY
