name: Cleanup exhaustif (assets)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cleanup assets (exhaustif)
        shell: bash
        run: |
          set -euo pipefail

          echo "== 1) Supprimer assets/materiaux =="
          rm -rf assets/materiaux || true

          echo "== 2) Supprimer configs inutiles =="
          rm -f assets/bandeaux/bandeaux-config.json || true
          rm -f assets/manifest/sizes.json || true

          echo "== 3) Nettoyage bandeaux : ne garder que assets/bandeaux/Mxx/image.webp =="
          # Pour chaque dossier Mxx, créer image.webp si absent, puis supprimer le reste des images/variants
          shopt -s nullglob
          for d in assets/bandeaux/M*/; do
            [ -d "$d" ] || continue

            mid="$(basename "$d")"
            canon="${d}image.webp"

            # Si canon absent, essayer de le créer depuis la "meilleure" source existante
            if [ ! -f "$canon" ]; then
              src=""
              # ordre de préférence
              for cand in \
                "${d}image_w1024.webp" \
                "${d}"*_w1024.webp \
                "${d}full/image.webp" \
                "${d}image.webp" \
                "${d}"*_w640.webp \
                "${d}thumb/image.webp" \
                "${d}image.png" \
                "${d}image.jpg" \
                "${d}image.jpeg" \
                "${d}image.gif"
              do
                if [ -f "$cand" ]; then src="$cand"; break; fi
              done

              if [ -n "$src" ]; then
                echo "Créer ${canon} depuis ${src}"
                mkdir -p "$d"
                cp "$src" "$canon"
              else
                echo "WARN: aucune source trouvée pour ${mid} (laisser tel quel)"
              fi
            fi

            # Supprimer toutes les images non canon
            # - variants *_w*.webp
            rm -f "${d}"*_w*.webp 2>/dev/null || true
            # - images dans full/ et thumb/
            rm -rf "${d}full" "${d}thumb" 2>/dev/null || true
            # - mauvais formats (et doublons)
            find "$d" -type f \( -iname "*.png" -o -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.gif" \) -delete || true

            # Supprimer les webp restants sauf le canon et description.txt
            find "$d" -type f -iname "*.webp" ! -name "image.webp" -delete || true

            # Nettoyer dossiers vides
            find "$d" -type d -empty -delete || true
          done

          echo "== 4) Canoniser hero et logo (si présents) =="
          # Hero
          if [ -f "assets/hero-bg_w1024.webp" ] && [ ! -f "assets/hero-bg.webp" ]; then
            cp "assets/hero-bg_w1024.webp" "assets/hero-bg.webp"
          elif [ -f "assets/hero-bg_w640.webp" ] && [ ! -f "assets/hero-bg.webp" ]; then
            cp "assets/hero-bg_w640.webp" "assets/hero-bg.webp"
          fi
          rm -f assets/hero-bg_w640.webp assets/hero-bg_w1024.webp 2>/dev/null || true

          # Logo
          if [ -f "assets/logo_w1024.webp" ] && [ ! -f "assets/logo.webp" ]; then
            cp "assets/logo_w1024.webp" "assets/logo.webp"
          elif [ -f "assets/logo_w640.webp" ] && [ ! -f "assets/logo.webp" ]; then
            cp "assets/logo_w640.webp" "assets/logo.webp"
          fi
          rm -f assets/logo_w640.webp assets/logo_w1024.webp 2>/dev/null || true

          echo "== 5) Supprimer mauvais formats dans assets/ (option agressive) =="
          # ⚠️ Agressif : supprime tous les png/jpg/jpeg/gif sous assets/
          # Si tu as des SVG nécessaires, ils ne sont PAS supprimés.
          find assets -type f \( -iname "*.png" -o -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.gif" \) -delete || true

          echo "== 6) Résumé =="
          echo "Fichiers images restants (assets/) :"
          find assets -type f \( -iname "*.webp" -o -iname "*.svg" \) | sed 's|^\./||' | sort | head -n 200

      - name: Commit changes
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "cleanup-bot"
            git config user.email "cleanup-bot@users.noreply.github.com"
            git add -A
            git commit -m "Cleanup exhaustif: remove duplicates, keep canonical webp assets"
            git push
          else
            echo "Nothing to commit."
          fi
